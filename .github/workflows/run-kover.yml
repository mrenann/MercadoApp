name: Android Kover Test Coverage

on:
  pull_request:
    branches: [ main ]

permissions:
  pull-requests: write
  contents: read

jobs:
  test-coverage:
    name: Generate Test Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests with Kover
        run: ./gradlew test koverXmlReport

      - name: Store Main report
        uses: actions/upload-artifact@v4
        with:
          name: main-coverage
          path: build/reports/kover/report.xml

      - name: Generate coverage report
        id: kover-report
        run: |
          REPORT_PATH=$(find build/reports/kover -name "report.xml" | head -n 1)
          
          if [ -z "$REPORT_PATH" ]; then
            echo "‚ùå Coverage report not found!"
            exit 1
          fi
          
          echo "‚úÖ Found report at: $REPORT_PATH"
          
          TOTAL_COVERAGE=$(grep -o 'line-rate="0\.[0-9]*"' "$REPORT_PATH" | grep -o '0\.[0-9]*')
          COVERAGE_PERCENTAGE=$(echo "$TOTAL_COVERAGE * 100" | bc)
          echo "üìä Coverage: ${COVERAGE_PERCENTAGE}%"
          echo "coverage=$COVERAGE_PERCENTAGE" >> $GITHUB_OUTPUT


      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: test-coverage
          message: |
            ## üìä Cobertura de C√≥digo
            
            **Cobertura Total: ${{ steps.kover-report.outputs.coverage }}%**
            
            <details>
              <summary>Detalhes de Cobertura</summary>
            
              Este relat√≥rio foi gerado pelo Kover v0.9.1
            
              Para melhorar a cobertura:
              - Adicione testes para fun√ß√µes e classes n√£o testadas
              - Assegure que fluxos condicionais estejam cobertos
              - Verifique que exce√ß√µes e casos de erro s√£o testados
            </details>

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: kover-report
          path: build/reports/kover/

      - name: Check coverage threshold
        run: |
          COVERAGE=${{ steps.kover-report.outputs.coverage }}
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "‚ö†Ô∏è Cobertura abaixo do limite recomendado de 70%"
            echo "Cobertura atual: $COVERAGE%"
          else
            echo "‚úÖ Cobertura acima do limite recomendado de 70%"
            echo "Cobertura atual: $COVERAGE%"
          fi